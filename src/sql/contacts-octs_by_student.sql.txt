SELECT
  studentDcid, enrollStat, studentNum, lname, fname, studentEmail, 
  gender, schoolNum, gradeLvl, homeRm, studentHomePhone,
  studentAddrStreet, studentAddrCity, studentAddrState, studentAddrZip,
  studentMailAddrStreet, studentMailAddrCity, studentMailAddrState, studentMailAddrZip,

  MIN(CASE WHEN (contactType='mother') THEN contactRelationshipType END) AS MotherRelationshipType,
  MIN(CASE WHEN (contactType='mother') THEN contactFirstName END) AS MotherFirstName,
  MIN(CASE WHEN (contactType='mother') THEN contactMiddleName END) AS MotherMiddleName,
  MIN(CASE WHEN (contactType='mother') THEN contactLastName END) AS MotherLastName,
  MIN(CASE WHEN (contactType='mother') THEN contactIsCustodialFlg END) AS MotherIsCustodialFlg,
  MIN(CASE WHEN (contactType='mother') THEN contactIsEmergencyFlg END) AS MotherIsEmergencyFlg,
  MIN(CASE WHEN (contactType='mother') THEN contactLivesWithFlg END) AS MotherLivesWithFlg,
  MIN(CASE WHEN (contactType='mother') THEN contactReceivesMailFlg END) AS MotherReceivesMailFlg,
  MIN(CASE WHEN (contactType='mother') THEN contactSchoolPickupFlg END) AS MotherSchoolPickupFlg,
  MIN(CASE WHEN (contactType='mother' AND emailType='current') 
           THEN contactEmailAddr END) AS MotherEmailAddress,
  MIN(CASE WHEN (contactType='mother' AND phoneType='home') 
           THEN contactPhoneNum END) AS MotherHomePhone,
  MIN(CASE WHEN (contactType='mother' AND phoneType='mobile') 
           THEN contactPhoneNum END) AS MotherMobilePhone,
  MIN(CASE WHEN (contactType='mother' AND phoneType='work') 
           THEN contactPhoneNum END) AS MotherWorkPhone,
  MIN(CASE WHEN (contactType='mother') THEN contactAddrStreet END) AS MotherAddrStreet,
  MIN(CASE WHEN (contactType='mother') THEN contactAddrUnit END) AS MotherAddrUnit,
  MIN(CASE WHEN (contactType='mother') THEN contactAddrLineTwo END) AS MotherAddrLineTwo,
  MIN(CASE WHEN (contactType='mother') THEN contactAddrCity END) AS MotherAddrCity,
  MIN(CASE WHEN (contactType='mother') THEN contactAddrState END) AS MotherAddrState,
  MIN(CASE WHEN (contactType='mother') THEN contactAddrPostalCode END) AS MotherAddrPostalCode,

  MIN(CASE WHEN (contactType='father') THEN contactRelationshipType END) AS FatherRelationshipType,
  MIN(CASE WHEN (contactType='father') THEN contactFirstName END) AS FatherFirstName,
  MIN(CASE WHEN (contactType='father') THEN contactMiddleName END) AS FatherMiddleName,
  MIN(CASE WHEN (contactType='father') THEN contactLastName END) AS FatherLastName, 
  MIN(CASE WHEN (contactType='father') THEN contactIsCustodialFlg END) AS FatherIsCustodialFlg,
  MIN(CASE WHEN (contactType='father') THEN contactIsEmergencyFlg END) AS FatherIsEmergencyFlg,
  MIN(CASE WHEN (contactType='father') THEN contactLivesWithFlg END) AS FatherLivesWithFlg,
  MIN(CASE WHEN (contactType='father') THEN contactReceivesMailFlg END) AS FatherReceivesMailFlg,
  MIN(CASE WHEN (contactType='father') THEN contactSchoolPickupFlg END) AS FatherSchoolPickupFlg,
  MIN(CASE WHEN (contactType='father' AND emailType='current') 
           THEN contactEmailAddr END) AS FatherEmailAddress, 
  MIN(CASE WHEN (contactType='father' AND phoneType='home') 
           THEN contactPhoneNum END) AS FatherHomePhone,
  MIN(CASE WHEN (contactType='father' AND phoneType='mobile') 
           THEN contactPhoneNum END) AS FatherMobilePhone,
  MIN(CASE WHEN (contactType='father' AND phoneType='work') 
           THEN contactPhoneNum END) AS FatherWorkPhone, 
  MIN(CASE WHEN (contactType='father') THEN contactAddrStreet END) AS FatherAddrStreet,
  MIN(CASE WHEN (contactType='father') THEN contactAddrUnit END) AS FatherAddrUnit,
  MIN(CASE WHEN (contactType='father') THEN contactAddrLineTwo END) AS FatherAddrLineTwo,
  MIN(CASE WHEN (contactType='father') THEN contactAddrCity END) AS FatherAddrCity,
  MIN(CASE WHEN (contactType='father') THEN contactAddrState END) AS FatherAddrState,
  MIN(CASE WHEN (contactType='father') THEN contactAddrPostalCode END) AS FatherAddrPostalCode,

  MIN(CASE WHEN (contactType='guardian') THEN contactRelationshipType END) AS GuardianRelationshipType,
  MIN(CASE WHEN (contactType='guardian') THEN contactFirstName END) AS GuardianFirstName,
  MIN(CASE WHEN (contactType='guardian') THEN contactMiddleName END) AS GuardianMiddleName,
  MIN(CASE WHEN (contactType='guardian') THEN contactLastName END) AS GuardianLastName, 
  MIN(CASE WHEN (contactType='guardian') THEN contactIsCustodialFlg END) AS GuardianIsCustodialFlg,
  MIN(CASE WHEN (contactType='guardian') THEN contactIsEmergencyFlg END) AS GuardianIsEmergencyFlg,
  MIN(CASE WHEN (contactType='guardian') THEN contactLivesWithFlg END) AS GuardianLivesWithFlg,
  MIN(CASE WHEN (contactType='guardian') THEN contactReceivesMailFlg END) AS GuardianReceivesMailFlg,
  MIN(CASE WHEN (contactType='guardian') THEN contactSchoolPickupFlg END) AS GuardianSchoolPickupFlg,
  MIN(CASE WHEN (contactType='guardian' AND emailType='current') 
           THEN contactEmailAddr END) AS GuardianEmailAddress, 
  MIN(CASE WHEN (contactType='guardian' AND phoneType='home') 
           THEN contactPhoneNum END) AS GuardianHomePhone,
  MIN(CASE WHEN (contactType='guardian' AND phoneType='mobile') 
           THEN contactPhoneNum END) AS GuardianMobilePhone,
  MIN(CASE WHEN (contactType='guardian' AND phoneType='work') 
           THEN contactPhoneNum END) AS GuardianWorkPhone,
  MIN(CASE WHEN (contactType='guardian') THEN contactAddrStreet END) AS GuardianAddrStreet,
  MIN(CASE WHEN (contactType='guardian') THEN contactAddrUnit END) AS GuardianAddrUnit,
  MIN(CASE WHEN (contactType='guardian') THEN contactAddrLineTwo END) AS GuardianAddrLineTwo,
  MIN(CASE WHEN (contactType='guardian') THEN contactAddrCity END) AS GuardianAddrCity,
  MIN(CASE WHEN (contactType='guardian') THEN contactAddrState END) AS GuardianAddrState,
  MIN(CASE WHEN (contactType='guardian') THEN contactAddrPostalCode END) AS GuardianAddrPostalCode,

  MIN(CASE WHEN (contactType='emergency1') THEN contactRelationshipType END) AS Emergency1RelationshipType,
  MIN(CASE WHEN (contactType='emergency1') THEN contactFirstName END) AS Emergency1FirstName,
  MIN(CASE WHEN (contactType='emergency1') THEN contactMiddleName END) AS Emergency1MiddleName,
  MIN(CASE WHEN (contactType='emergency1') THEN contactLastName END) AS Emergency1LastName, 
  MIN(CASE WHEN (contactType='emergency1') THEN contactIsCustodialFlg END) AS Emergency1IsCustodialFlg,
  MIN(CASE WHEN (contactType='emergency1') THEN contactIsEmergencyFlg END) AS Emergency1IsEmergencyFlg,
  MIN(CASE WHEN (contactType='emergency1') THEN contactLivesWithFlg END) AS Emergency1LivesWithFlg,
  MIN(CASE WHEN (contactType='emergency1') THEN contactReceivesMailFlg END) AS Emergency1ReceivesMailFlg,
  MIN(CASE WHEN (contactType='emergency1') THEN contactSchoolPickupFlg END) AS Emergency1SchoolPickupFlg,
  MIN(CASE WHEN (contactType='emergency1' AND emailType='current') 
           THEN contactEmailAddr END) AS Emergency1EmailAddress,
  MIN(CASE WHEN (contactType='emergency1' AND phoneType='home') 
           THEN contactPhoneNum END) AS Emergency1HomePhone,
  MIN(CASE WHEN (contactType='emergency1' AND phoneType='mobile') 
           THEN contactPhoneNum END) AS Emergency1MobilePhone,
  MIN(CASE WHEN (contactType='emergency1' AND phoneType='work') 
           THEN contactPhoneNum END) AS Emergency1WorkPhone,
  MIN(CASE WHEN (contactType='emergency1') THEN contactAddrStreet END) AS Emergency1AddrStreet,
  MIN(CASE WHEN (contactType='emergency1') THEN contactAddrUnit END) AS Emergency1AddrUnit,
  MIN(CASE WHEN (contactType='emergency1') THEN contactAddrLineTwo END) AS Emergency1AddrLineTwo,
  MIN(CASE WHEN (contactType='emergency1') THEN contactAddrCity END) AS Emergency1AddrCity,
  MIN(CASE WHEN (contactType='emergency1') THEN contactAddrState END) AS Emergency1AddrState,
  MIN(CASE WHEN (contactType='emergency1') THEN contactAddrPostalCode END) AS Emergency1AddrPostalCode,

  MIN(CASE WHEN (contactType='emergency2') THEN contactRelationshipType END) AS Emergency2RelationshipType,
  MIN(CASE WHEN (contactType='emergency2') THEN contactFirstName END) AS Emergency2FirstName,
  MIN(CASE WHEN (contactType='emergency2') THEN contactMiddleName END) AS Emergency2MiddleName,
  MIN(CASE WHEN (contactType='emergency2') THEN contactLastName END) AS Emergency2LastName, 
  MIN(CASE WHEN (contactType='emergency2') THEN contactIsCustodialFlg END) AS Emergency2IsCustodialFlg,
  MIN(CASE WHEN (contactType='emergency2') THEN contactIsEmergencyFlg END) AS Emergency2IsEmergencyFlg,
  MIN(CASE WHEN (contactType='emergency2') THEN contactLivesWithFlg END) AS Emergency2LivesWithFlg,
  MIN(CASE WHEN (contactType='emergency2') THEN contactReceivesMailFlg END) AS Emergency2ReceivesMailFlg,
  MIN(CASE WHEN (contactType='emergency2') THEN contactSchoolPickupFlg END) AS Emergency2SchoolPickupFlg,
  MIN(CASE WHEN (contactType='emergency2' AND emailType='current') 
           THEN contactEmailAddr END) AS Emergency2EmailAddress, 
  MIN(CASE WHEN (contactType='emergency2' AND phoneType='home') 
           THEN contactPhoneNum END) AS Emergency2HomePhone,
  MIN(CASE WHEN (contactType='emergency2' AND phoneType='mobile') 
           THEN contactPhoneNum END) AS Emergency2MobilePhone,
  MIN(CASE WHEN (contactType='emergency2' AND phoneType='work') 
           THEN contactPhoneNum END) AS Emergency2WorkPhone, 
  MIN(CASE WHEN (contactType='emergency2') THEN contactAddrStreet END) AS Emergency2AddrStreet,
  MIN(CASE WHEN (contactType='emergency2') THEN contactAddrUnit END) AS Emergency2AddrUnit,
  MIN(CASE WHEN (contactType='emergency2') THEN contactAddrLineTwo END) AS Emergency2AddrLineTwo,
  MIN(CASE WHEN (contactType='emergency2') THEN contactAddrCity END) AS Emergency2AddrCity,
  MIN(CASE WHEN (contactType='emergency2') THEN contactAddrState END) AS Emergency2AddrState,
  MIN(CASE WHEN (contactType='emergency2') THEN contactAddrPostalCode END) AS Emergency2AddrPostalCode,

  MIN(CASE WHEN (contactType='emergency3') THEN contactRelationshipType END) AS Emergency3RelationshipType,
  MIN(CASE WHEN (contactType='emergency3') THEN contactFirstName END) AS Emergency3FirstName,
  MIN(CASE WHEN (contactType='emergency3') THEN contactMiddleName END) AS Emergency3MiddleName,
  MIN(CASE WHEN (contactType='emergency3') THEN contactLastName END) AS Emergency3LastName, 
  MIN(CASE WHEN (contactType='emergency3') THEN contactIsCustodialFlg END) AS Emergency3IsCustodialFlg,
  MIN(CASE WHEN (contactType='emergency3') THEN contactIsEmergencyFlg END) AS Emergency3IsEmergencyFlg,
  MIN(CASE WHEN (contactType='emergency3') THEN contactLivesWithFlg END) AS Emergency3LivesWithFlg,
  MIN(CASE WHEN (contactType='emergency3') THEN contactReceivesMailFlg END) AS Emergency3ReceivesMailFlg,
  MIN(CASE WHEN (contactType='emergency3') THEN contactSchoolPickupFlg END) AS Emergency3SchoolPickupFlg,
  MIN(CASE WHEN (contactType='emergency3' AND emailType='current') 
           THEN contactEmailAddr END) AS Emergency3EmailAddress, 
  MIN(CASE WHEN (contactType='emergency3' AND phoneType='home') 
           THEN contactPhoneNum END) AS Emergency3HomePhone,
  MIN(CASE WHEN (contactType='emergency3' AND phoneType='mobile') 
           THEN contactPhoneNum END) AS Emergency3MobilePhone,
  MIN(CASE WHEN (contactType='emergency3' AND phoneType='work') 
           THEN contactPhoneNum END) AS Emergency3WorkPhone,
  MIN(CASE WHEN (contactType='emergency3') THEN contactAddrStreet END) AS Emergency3AddrStreet,
  MIN(CASE WHEN (contactType='emergency3') THEN contactAddrUnit END) AS Emergency3AddrUnit,
  MIN(CASE WHEN (contactType='emergency3') THEN contactAddrLineTwo END) AS Emergency3AddrLineTwo,
  MIN(CASE WHEN (contactType='emergency3') THEN contactAddrCity END) AS Emergency3AddrCity,
  MIN(CASE WHEN (contactType='emergency3') THEN contactAddrState END) AS Emergency3AddrState,
  MIN(CASE WHEN (contactType='emergency3') THEN contactAddrPostalCode END) AS Emergency3AddrPostalCode

FROM ( SELECT
  s.Dcid As studentDcid,
  s.Enroll_Status AS enrollStat,
  s.Student_Number AS studentNum,
  s.Last_Name AS lname,
  s.First_Name AS fname,
  psc.Email AS studentEmail,
  s.Gender AS gender,
  s.SchoolID AS schoolNum,
  s.Grade_Level AS gradeLvl,
  s.Home_room AS homeRm,
  s.Home_Phone AS studentHomePhone,
  s.Street AS studentAddrStreet,
  s.City AS studentAddrCity,
  s.State AS studentAddrState,
  s.Zip as studentAddrZip,
  s.Mailing_Street AS studentMailAddrStreet,
  s.Mailing_City AS studentMailAddrCity,
  s.Mailing_State AS studentMailAddrState,
  s.Mailing_Zip as studentMailAddrZip,
  csrel.Code AS contactRelationshipType, 
  scd.IsCustodial AS contactIsCustodialFlg,
  scd.IsEmergency AS contactIsEmergencyFlg,
  scd.LivesWithFlg AS contactLivesWithFlg,
  scd.ReceivesMailFlg AS contactReceivesMailFlg,
  scd.SchoolPickupFlg AS contactSchoolPickupFlg,
  p.FirstName AS contactFirstName,
  p.MiddleName AS contactMiddleName,
  p.LastName AS contactLastName,
  LOWER(ocm.OriginalContactType) AS contactType,
  LOWER(cspt.Code) AS phoneType,
  ppna.PhoneNumberAsEntered AS contactPhoneNum,
  ppna.PhoneNumberPriorityOrder,
  LOWER(cset.Code) AS emailType,
  emad.EmailAddress as contactEmailAddr,
  peaa.EmailAddressPriorityOrder,
  peaa.IsPrimaryEmailAddress,
  pad.Street AS contactAddrStreet,
  pad.Unit AS contactAddrUnit,
  pad.LineTwo AS contactAddrLineTwo,
  pad.City AS contactAddrCity,
  csas.Code AS contactAddrState,
  pad.PostalCode as contactAddrPostalCode

FROM Students s

LEFT OUTER JOIN 
  ( PSM_StudentContact psc 
  
    INNER JOIN PSM_StudentContactType psct ON psc.StudentContactTypeId= psct.Id 
      AND psct.Name='Self' 
  
    INNER JOIN Sync_StudentMap ssm ON psc.StudentId = ssm.StudentId
  ) ON s.Dcid = ssm.StudentsDcid 

LEFT OUTER JOIN StudentContactAssoc sca ON s.Dcid = sca.StudentDcid
LEFT OUTER JOIN Person p ON sca.PersonId = p.id
LEFT OUTER JOIN StudentContactDetail scd ON sca.StudentContactAssocId = scd.StudentContactAssocId
LEFT OUTER JOIN CodeSet csrel ON scd.RelationshipTypeCodeSetId = csrel.CodeSetId
LEFT OUTER JOIN OriginalContactMap ocm ON sca.StudentContactAssocid = ocm.StudentContactAssocId

LEFT OUTER JOIN PersonPhoneNumberAssoc ppna ON  p.Id = ppna.PersonId
LEFT OUTER JOIN PhoneNumber pn ON ppna.PhoneNumberId = pn.PhoneNumberID
LEFT OUTER JOIN CodeSet cspt ON ppna.PhoneTypeCodeSetID = cspt.CodeSetID
LEFT OUTER JOIN PersonEmailAddressAssoc peaa ON  p.Id = peaa.PersonId
LEFT OUTER JOIN EmailAddress emad ON peaa.EmailAddressId = emad.EmailAddressId
LEFT OUTER JOIN CodeSet cset ON peaa.EmailTypeCodeSetID = cset.CodeSetID

LEFT OUTER JOIN PersonAddressAssoc paa ON  p.Id = paa.PersonId
LEFT OUTER JOIN PersonAddress pad ON paa.PersonAddressId = pad.PersonAddressId
LEFT OUTER JOIN CodeSet csat ON paa.AddressTypeCodeSetID = csat.CodeSetID

LEFT OUTER JOIN CodeSet csas ON pad.StatesCodeSetID = csas.CodeSetID

WHERE (LOWER(ocm.OriginalContactType) IN ('mother','father','guardian','emergency1','emergency2','emergency3')
       OR ocm.OriginalContactType IS NULL)
  AND (LOWER(cspt.Code) IN ('home','mobile','work') OR cspt.Code IS NULL)
  AND (LOWER(cset.Code) IN ('current') OR cset.Code IS NULL)

  AND ((ppna.PersonPhoneNumberAssocId IS NULL) OR 
       (p.Id, ppna.PhoneTypeCodeSetID, (ppna.PhoneNumberPriorityOrder - (ppna.IsPreferred * 100000)))
        IN (SELECT PersonId, PhoneTypeCodeSetID, MIN(PhoneNumberPriorityOrder - (IsPreferred * 100000))
            FROM PersonPhoneNumberAssoc GROUP BY PersonId, PhoneTypeCodeSetID))

  AND (peaa.PersonEmailAddressAssocId IS NULL OR
       (p.Id, peaa.EmailTypeCodeSetID, (peaa.EmailAddressPriorityOrder - (peaa.IsPrimaryEmailAddress * 100000)))
        IN (SELECT PersonId, EmailTypeCodeSetID, MIN(EmailAddressPriorityOrder - (IsPrimaryEmailAddress * 100000))
            FROM PersonEmailAddressAssoc GROUP BY PersonId, EmailTypeCodeSetID))
  
  AND (paa.PersonAddressAssocId IS NULL OR
       (p.Id, paa.AddressTypeCodeSetID, paa.AddressPriorityOrder)
        IN (SELECT PersonId, AddressTypeCodeSetID, MIN(AddressPriorityOrder)
            FROM PersonAddressAssoc GROUP BY PersonId, AddressTypeCodeSetID))
)

GROUP BY studentDcid, enrollStat, studentNum, lname, fname, studentEmail, 
  gender, schoolNum, gradeLvl, homeRm, studentHomePhone,
  studentAddrStreet, studentAddrCity,
  studentAddrState, studentAddrZip,
  studentMailAddrStreet, studentMailAddrCity,
  studentMailAddrState, studentMailAddrZip
  